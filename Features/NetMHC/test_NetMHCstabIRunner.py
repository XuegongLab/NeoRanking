from unittest import TestCase

import numpy as np

from Features.NetMHC.NetMHCstabIRunner import *
from Utils.DataManager import *


class TestNetMHCstabIRunner(TestCase):

    def test_get_peptide_info(self):
        mgr = DataManager()
        data = mgr.get_processed_data('0YM1', 'rt_netmhc')

        idx_0, mut_peptides_0, mut_alleles_0, wt_peptides_0, wt_alleles_0 = NetMHCstabIRunner.get_peptide_info_long(data, 0)
        idx_1, mut_peptides_1, mut_alleles_1, wt_peptides_1, wt_alleles_1 = NetMHCstabIRunner.get_peptide_info_long(data, 1)

        self.assertEqual(len(mut_peptides_0), len(mut_peptides_1))
        self.assertEqual(len(wt_peptides_0), len(wt_peptides_1))
        self.assertEqual(len(mut_peptides_0), len(mut_alleles_0))
        self.assertEqual(len(wt_peptides_0), len(wt_alleles_0))

        idx, mut_peptides, mut_alleles, wt_peptides, wt_alleles = NetMHCstabIRunner.get_peptide_info_long(data, 5)
        self.assertEqual(None, idx)

    def test_constructor(self):
        netMHCstabIRunner = NetMHCstabIRunner(exe_base_dir=Parameters().get_exe_dir())

        self.assertTrue(os.path.isfile(netMHCstabIRunner.netMHC_path))

    def test_split_length(self):
        data = DataManager().get_processed_data('0YM1', 'rt_netmhc')
        idx_0, mut_peptides_0, mut_alleles_0, wt_peptides_0, wt_alleles_0 = NetMHCstabIRunner.get_peptide_info_long(data, 0)

        allele_len_peptide_dict = NetMHCRunner.split_length_allele(mut_peptides_0, mut_alleles_0)

        self.assertEqual(11, len(allele_len_peptide_dict))
        for (a, p) in zip(mut_alleles_0, mut_peptides_0):
            if len(p) > 7:
                peptides = allele_len_peptide_dict[(a, len(p))]
                self.assertTrue(len(peptides) > 0)
                for pp in peptides:
                    al = mut_alleles_0[mut_peptides_0 == pp][0]
                    self.assertEqual(len(p), len(pp))
                    self.assertEqual(al, a)

    def test_read_result(self):
        netmhcstab_out_stream1 = b'# /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/bin/netMHCstabpan -f /tmp/tmp0ccm880e.txt -inptype 1 -a HLA-A24:02 -affpred /home/localadmin/Programmes/netMHCpan-4.1/Linux_x86_64/bin/netMHCpan\n# Wed Aug 18 11:22:20 2021\n# User: localadmin\n# PWD : /home/localadmin/Priorization/python/Features/NetMHC\n# Host: Linux hos64205 5.4.0-80-generic x86_64\n# -f       /tmp/tmp0ccm880e.txt File name with input\n# -inptype 1                    Input type [0] FASTA [1] Peptide\n# -a       HLA-A24:02           HLA allele\n# -affpred /home/localadmin/Programmes/netMHCpan-4.1/Linux_x86_64/bin/netMHCpan MHC affinity predictor\n# Command line parameters set to:\n#\t[-rdir filename]     /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64 Home directory for NetMHpan\n#\t[-syn filename]      /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/data/syn/synaps Synaps file\n#\t[-v]                 0                    Verbose mode\n#\t[-dirty]             0                    Dirty mode, leave tmp dir+files\n#\t[-tdir filename]     /var/tmp             Temporary directory (Default $$)\n#\t[-hlapseudo filename] /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/data/MHC_pseudo.dat File with HLA pseudo sequences\n#\t[-hlaseq filename]                        File with full length HLA sequences\n#\t[-a line]            HLA-A24:02           HLA allele\n#\t[-f filename]        /tmp/tmp0ccm880e.txt File name with input\n#\t[-w]                 0                    w option for webface\n#\t[-s int]             -1                   Sort output on descending [0] stability, [1] affinity, [2] combined, [-1] no sorting\n#\t[-p]                 0                    Use peptide input\n#\t[-rht float]         0.500000             Rank Threshold for high binding peptides\n#\t[-rlt float]         2.000000             Rank Threshold for low binding peptides\n#\t[-l string]          9                    Peptide length [8-11] (multiple length with ,)\n#\t[-xls]               0                    Save output to xls file\n#\t[-xlsfile filename]  NetMHCstabpan.xls    Filename for xls dump\n#\t[-t float]           -99.900002           Threshold for output\n#\t[-thrfmt filename]   /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/data/threshold/%s.thr Format for threshold filenames\n#\t[-expfix]            0                    Exclude prefix from synlist\n#\t[-version filename]  /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/data/version File with version information\n#\t[-inptype int]       1                    Input type [0] FASTA [1] Peptide\n#\t[-listMHC]           0                    Print list of alleles included in netMHCpan\n#\t[-affpred filename]  /home/localadmin/Programmes/netMHCpan-4.1/Linux_x86_64/bin/netMHCpan MHC affinity predictor\n#\t[-waff float]        0.800000             Relative Weight on affinity\n#\t[-ia]                0                    Include affinity predictions\n#\t[-s1 int]            -1                   Sort option only used by www\n#\t[-s2 int]            -1                   Sort option only used by www\n\n# NetMHCstabpan version 1.0\n\n# Input is in PEPTIDE format\n\nHLA-A24:02 : Distance to traning data  0.000 (using nearest neighbor HLA-A24:02)\n\n# Rank Threshold for Strong binding peptides   0.500\n# Rank Threshold for Weak binding peptides   2.000\n-----------------------------------------------------------------------------------------------------\n pos      HLA         peptide         Identity       Pred     Thalf(h) %Rank_Stab BindLevel\n-----------------------------------------------------------------------------------------------------\n    0  HLA-A*24:02  TYWVTNFLWNI         PEPLIST      0.883       5.58       0.15      <= SB\n    0  HLA-A*24:02  RYLRVKLTVKF         PEPLIST      0.970      22.88       0.02      <= SB\n    0  HLA-A*24:02  THSCTCSNDQV         PEPLIST      0.008       0.15      25.00\n    0  HLA-A*24:02  ALPEKVVNKQY         PEPLIST      0.020       0.18      17.00\n    0  HLA-A*24:02  SPFLRFYLGKL         PEPLIST      0.030       0.20      14.00\n    0  HLA-A*24:02  VYKDLESFTYF         PEPLIST      0.891       6.02       0.15      <= SB\n    0  HLA-A*24:02  EHSTLLILGGL         PEPLIST      0.018       0.17      18.00\n    0  HLA-A*24:02  KFLAQSQKGLF         PEPLIST      0.873       5.11       0.17      <= SB\n    0  HLA-A*24:02  EVLIQQGGLKY         PEPLIST      0.009       0.15      24.00\n    0  HLA-A*24:02  ETARGTFRGQY         PEPLIST      0.017       0.17      18.00\n    0  HLA-A*24:02  QHPCQNQEQKV         PEPLIST      0.005       0.13      30.00\n    0  HLA-A*24:02  GHSALISKDHV         PEPLIST      0.007       0.14      27.00\n    0  HLA-A*24:02  TLDSGVLTALW         PEPLIST      0.119       0.33       5.00\n    0  HLA-A*24:02  LHLQRWIDTSL         PEPLIST      0.068       0.26       8.00\n-----------------------------------------------------------------------------------------------------\n\nProtein PEPLIST. Allele HLA-A*24:02. Number of high binders 4. Number of weak binders 0. Number of peptides 14\n\n-----------------------------------------------------------------------------------------------------\n'
        netmhcstab_out_stream2 = b'# /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/bin/netMHCstabpan -f /tmp/tmpgaezpv3c.txt -inptype 1 -a HLA-A24:02 -affpred /home/localadmin/Programmes/netMHCpan-4.1/Linux_x86_64/bin/netMHCpan\n# Wed Aug 18 12:21:49 2021\n# User: localadmin\n# PWD : /home/localadmin/Priorization/python/Features/NetMHC\n# Host: Linux hos64205 5.4.0-80-generic x86_64\n# -f       /tmp/tmpgaezpv3c.txt File name with input\n# -inptype 1                    Input type [0] FASTA [1] Peptide\n# -a       HLA-A24:02           HLA allele\n# -affpred /home/localadmin/Programmes/netMHCpan-4.1/Linux_x86_64/bin/netMHCpan MHC affinity predictor\n# Command line parameters set to:\n#\t[-rdir filename]     /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64 Home directory for NetMHpan\n#\t[-syn filename]      /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/data/syn/synaps Synaps file\n#\t[-v]                 0                    Verbose mode\n#\t[-dirty]             0                    Dirty mode, leave tmp dir+files\n#\t[-tdir filename]     /var/tmp             Temporary directory (Default $$)\n#\t[-hlapseudo filename] /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/data/MHC_pseudo.dat File with HLA pseudo sequences\n#\t[-hlaseq filename]                        File with full length HLA sequences\n#\t[-a line]            HLA-A24:02           HLA allele\n#\t[-f filename]        /tmp/tmpgaezpv3c.txt File name with input\n#\t[-w]                 0                    w option for webface\n#\t[-s int]             -1                   Sort output on descending [0] stability, [1] affinity, [2] combined, [-1] no sorting\n#\t[-p]                 0                    Use peptide input\n#\t[-rht float]         0.500000             Rank Threshold for high binding peptides\n#\t[-rlt float]         2.000000             Rank Threshold for low binding peptides\n#\t[-l string]          9                    Peptide length [8-11] (multiple length with ,)\n#\t[-xls]               0                    Save output to xls file\n#\t[-xlsfile filename]  NetMHCstabpan.xls    Filename for xls dump\n#\t[-t float]           -99.900002           Threshold for output\n#\t[-thrfmt filename]   /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/data/threshold/%s.thr Format for threshold filenames\n#\t[-expfix]            0                    Exclude prefix from synlist\n#\t[-version filename]  /home/localadmin/Programmes/netMHCstabpan-1.0/Linux_x86_64/data/version File with version information\n#\t[-inptype int]       1                    Input type [0] FASTA [1] Peptide\n#\t[-listMHC]           0                    Print list of alleles included in netMHCpan\n#\t[-affpred filename]  /home/localadmin/Programmes/netMHCpan-4.1/Linux_x86_64/bin/netMHCpan MHC affinity predictor\n#\t[-waff float]        0.800000             Relative Weight on affinity\n#\t[-ia]                0                    Include affinity predictions\n#\t[-s1 int]            -1                   Sort option only used by www\n#\t[-s2 int]            -1                   Sort option only used by www\n\n# NetMHCstabpan version 1.0\n\n# Input is in PEPTIDE format\n\nHLA-A24:02 : Distance to traning data  0.000 (using nearest neighbor HLA-A24:02)\n\n# Rank Threshold for Strong binding peptides   0.500\n# Rank Threshold for Weak binding peptides   2.000\n-----------------------------------------------------------------------------------------------------\n pos      HLA         peptide         Identity       Pred     Thalf(h) %Rank_Stab BindLevel\n-----------------------------------------------------------------------------------------------------\n    0  HLA-A*24:02   DPVVKVVSAM         PEPLIST      0.003       0.12      33.00\n    0  HLA-A*24:02   YPLAYVATKL         PEPLIST      0.118       0.32       5.00\n    0  HLA-A*24:02   YYCMQATQFS         PEPLIST      0.062       0.25       8.50\n    0  HLA-A*24:02   NKDLTADRTI         PEPLIST      0.001       0.09      55.00\n    0  HLA-A*24:02   SYTCKCPRGF         PEPLIST      0.569       1.23       0.80      <= WB\n    0  HLA-A*24:02   YYLPTQQRPL         PEPLIST      0.826       3.63       0.25      <= SB\n    0  HLA-A*24:02   YYLPTQQRPL         PEPLIST      0.826       3.63       0.25      <= SB\n    0  HLA-A*24:02   VPKNSPLNSL         PEPLIST      0.013       0.16      21.00\n    0  HLA-A*24:02   SYGPNLLESL         PEPLIST      0.585       1.29       0.80      <= WB\n    0  HLA-A*24:02   QHEAVCKEEI         PEPLIST      0.005       0.13      30.00\n    0  HLA-A*24:02   SPKNPKKAAL         PEPLIST      0.007       0.14      27.00\n    0  HLA-A*24:02   QRIHTGETPF         PEPLIST      0.027       0.19      15.00\n    0  HLA-A*24:02   HRLGNNTTAW         PEPLIST      0.051       0.23      10.00\n    0  HLA-A*24:02   THTCQSDMNI         PEPLIST      0.020       0.18      17.00\n    0  HLA-A*24:02   RRFSDHGAAL         PEPLIST      0.022       0.18      17.00\n    0  HLA-A*24:02   EPSADEDDLI         PEPLIST      0.001       0.10      42.00\n    0  HLA-A*24:02   AADPPGPALL         PEPLIST      0.015       0.17      19.00\n    0  HLA-A*24:02   ATDKKTETKW         PEPLIST      0.040       0.22      12.00\n    0  HLA-A*24:02   ATHASLIFSL         PEPLIST      0.060       0.25       9.00\n    0  HLA-A*24:02   TVINNAADFY         PEPLIST      0.028       0.19      14.00\n    0  HLA-A*24:02   EVMNLNEHSM         PEPLIST      0.016       0.17      19.00\n    0  HLA-A*24:02   TPRGLCDLEI         PEPLIST      0.003       0.12      33.00\n    0  HLA-A*24:02   IWTERLKMQF         PEPLIST      0.650       1.61       0.60      <= WB\n    0  HLA-A*24:02   AYLEVEESKF         PEPLIST      0.850       4.28       0.20      <= SB\n    0  HLA-A*24:02   HPLPSEPVGI         PEPLIST      0.011       0.15      22.00\n    0  HLA-A*24:02   NFGPMKGENF         PEPLIST      0.262       0.52       2.50\n    0  HLA-A*24:02   SPSSPPPASL         PEPLIST      0.008       0.14      26.00\n    0  HLA-A*24:02   EFHPSIMSQY         PEPLIST      0.051       0.23      10.00\n    0  HLA-A*24:02   MPGPPGQPGL         PEPLIST      0.004       0.13      30.00\n    0  HLA-A*24:02   TPILTILICL         PEPLIST      0.027       0.19      15.00\n    0  HLA-A*24:02   VYFGHDSKLF         PEPLIST      0.874       5.17       0.17      <= SB\n    0  HLA-A*24:02   KLANERLMTL         PEPLIST      0.094       0.29       6.50\n    0  HLA-A*24:02   ELVHFLLFKY         PEPLIST      0.007       0.14      26.00\n-----------------------------------------------------------------------------------------------------\n\nProtein PEPLIST. Allele HLA-A*24:02. Number of high binders 4. Number of weak binders 3. Number of peptides 33\n\n-----------------------------------------------------------------------------------------------------\n'
        res = NetMHCstabIRunner(exe_base_dir=Parameters().get_exe_dir()).read_result(netmhcstab_out_stream2)
        self.assertEqual((33, 7), res.shape)

        res = NetMHCstabIRunner(exe_base_dir=Parameters().get_exe_dir()).read_result(netmhcstab_out_stream1)
        self.assertEqual((14, 7), res.shape)

    def test_add_features_long(self):
        netMHCstabIRunner = NetMHCstabIRunner(exe_base_dir=Parameters().get_exe_dir())
        stab_data = netMHCstabIRunner.add_features('0YM1', 'rt_netmhc', 'test_stab', 'long', write_res=False)

        self.assertEqual(stab_data.shape[0], DataManager().get_processed_data('0YM1', 'rt_netmhc').shape[0])

    def test_add_features_short(self):
        netMHCstabIRunner = NetMHCstabIRunner(exe_base_dir=Parameters().get_exe_dir())
        stab_data = netMHCstabIRunner.add_features('2098', 'rt', 'test_stab', 'short', write_res=False)

        self.assertEqual(stab_data.shape[0], DataManager().get_processed_data('2098', 'rt', 'short').shape[0])
        self.assertTrue('mut_Stab_Score' in stab_data.columns)

        netMHCstabIRunner = NetMHCstabIRunner(exe_base_dir=Parameters().get_exe_dir())
        stab_data = netMHCstabIRunner.add_features('0YM1', 'rt', 'test_stab', 'short', write_res=False)

        self.assertEqual(stab_data.shape[0], DataManager().get_processed_data('0YM1', 'rt', 'short').shape[0])
        self.assertTrue('mut_Stab_Score' in stab_data.columns)

    def test_format_allele_short(self):
        self.assertEqual('HLA-C06:02', NetMHCstabIRunner.format_allele_short('C0602'))
